<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book with Michael</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .form-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus,
        select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .button-group button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .button-group button:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }
        
        .button-group button.selected {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .service-description {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 5px;
        }
        
        button[type="submit"] {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        button[type="submit"]:hover {
            background-color: #1a252f;
        }
        
        #confirmation {
            display: none;
            margin-top: 30px;
            padding: 20px;
            border-radius: 6px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        #confirmation h2 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .availability-note {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .closed-day-note {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .barber-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        
        .barber-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #666;
        }
        
        .barber-details {
            flex: 1;
        }
        
        .barber-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        option:disabled {
            color: #999;
            background-color: #f5f5f5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive styles */
        @media (min-width: 768px) {
            .form-row {
                display: flex;
                gap: 20px;
            }
            
            .form-row .form-group {
                flex: 1;
            }
            
            button[type="submit"] {
                width: auto;
                padding: 12px 40px;
                margin: 0 auto;
                display: block;
            }
        }
        
        /* Service section with better spacing */
        .service-section {
            margin-bottom: 30px;
        }
        
        .service-section .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .service-section .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Book an Appointment with Michael</h1>
    
    <div class="form-container">
        <div class="barber-info">
            <div class="barber-photo">M</div>
            <div class="barber-details">
                <div class="barber-name">Michael</div>
                <p>Master Barber</p>
            </div>
        </div>
        
        <div class="availability-note">
            <strong>Michael's Schedule:</strong> Monday, Thursday, Friday (10AM-7PM), Saturday (9AM-6PM)
        </div>
        
        <div class="closed-day-note">
            <strong>Closed Days:</strong> We are closed on Wednesdays and Sundays.
        </div>
        
        <form id="appointmentForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number:</label>
                    <input type="text" id="phone" name="phone" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group service-section">
                <label>Select Your Service:</label>
                <div class="button-group" id="serviceButtons">
                    <button type="button" data-value="Haircut">Haircut - $45</button>
                    <button type="button" data-value="Haircut & Beard Trim">Haircut & Beard Trim - $60</button>
                    <button type="button" data-value="Beard Trim">Beard Trim - $30</button>
                    <button type="button" data-value="Hot Towel Shave">Hot Towel Shave - $40</button>
                    <button type="button" data-value="Head Shave">Head Shave - $40</button>
                    <button type="button" data-value="The Distinguished Gentleman">Distinguished Gentleman - $75</button>
                    <button type="button" data-value="Head & Face Hot Towel Shave">Head & Face Shave - $75</button>
                </div>
                
                <div id="serviceDescription" class="service-description">
                    Please select a service to see its description.
                </div>
                <input type="hidden" id="service" name="service" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="date">Appointment Date:</label>
                    <input type="date" id="date" name="date" required>
                </div>
                
                <div class="form-group">
                    <label for="time">Appointment Time: <span id="checkingAvailability" style="display:none;"><span class="loading"></span> Checking availability...</span></label>
                    <select id="time" name="time" required>
                        <option value="">Select a date first</option>
                    </select>
                </div>
            </div>
            
            <button type="submit">Book My Appointment</button>
        </form>
    </div>
    
    <div id="confirmation">
        <h2>Appointment Confirmed!</h2>
        <p id="confirmationMessage"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').setAttribute('min', today);
            
            // Service descriptions
            const serviceDescriptions = {
                "Haircut": "Classic haircut with precision styling (45 minutes).",
                "Haircut & Beard Trim": "Comprehensive haircut and beard shaping for a complete look (60 minutes).",
                "Beard Trim": "Precise beard grooming and shaping (30 minutes).",
                "Hot Towel Shave": "Relaxing hot towel shave for a smooth finish (30 minutes).",
                "Head Shave": "Clean and smooth head shave (40 minutes).",
                "The Distinguished Gentleman": "VIP experience at Capitol Tower with complimentary whiskey, haircut & beard trim with straight razor hot towel (75 minutes).",
                "Head & Face Hot Towel Shave": "Complete head and face hot towel shave treatment (75 minutes)."
            };
            
            // Service buttons
            const serviceButtons = document.getElementById('serviceButtons');
            const serviceInput = document.getElementById('service');
            const serviceDescriptionElement = document.getElementById('serviceDescription');
            
            serviceButtons.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') {
                    // Remove 'selected' class from all buttons
                    serviceButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                    // Add 'selected' class to the clicked button
                    e.target.classList.add('selected');
                    const serviceValue = e.target.dataset.value;
                    serviceInput.value = serviceValue;
                    
                    // Update the service description
                    serviceDescriptionElement.textContent = serviceDescriptions[serviceValue] || "Service description not available.";
                }
            });

            // Date selection check
            const dateInput = document.getElementById('date');
            const timeSelect = document.getElementById('time');
            const checkingAvailability = document.getElementById('checkingAvailability');
            
            dateInput.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const dayOfWeek = selectedDate.getDay();
                
                // Check if selected day is Wednesday (3) or Sunday (0)
                if (dayOfWeek === 3 || dayOfWeek === 0) {
                    alert('We are closed on Wednesdays and Sundays. Please select another day.');
                    this.value = '';
                    return;
                }
                
                // Check if the date is a day Michael doesn't work (Tuesday=2)
                if (![1, 4, 5, 6].includes(dayOfWeek)) {
                    alert('Michael is only available on Mondays, Thursdays, Fridays, and Saturdays. Please select another day.');
                    this.value = '';
                    return;
                }
                
                // Check booked appointments
                checkBookedAppointments();
            });
            
            // Function to check for booked appointments using webhook
            function checkBookedAppointments() {
                const selectedDate = dateInput.value;
                
                if (!selectedDate) return;
                
                // Show loading indicator
                checkingAvailability.style.display = 'inline-block';
                timeSelect.innerHTML = '<option value="">Loading available times...</option>';
                
                // First generate base time slots
                updateAvailableTimes(false);
                
                // Then check availability from the API
                fetch(`https://bitethatthing.app.n8n.cloud/webhook/f877d285-d1ac-4e32-83e1-2320a4e69957?date=${selectedDate}&barber=Michael`)
                    .then(response => response.json())
                    .then(data => {
                        // Hide loading indicator
                        checkingAvailability.style.display = 'none';
                        
                        console.log("API Response:", data);
                        
                        // Check if we have booked times
                        if (data.bookedTimes && data.bookedTimes.length > 0) {
                            console.log("Booked times:", data.bookedTimes);
                            
                            // Loop through all time options
                            Array.from(timeSelect.options).forEach(option => {
                                if (option.value === '') return; // Skip the placeholder option
                                
                                // Format option value for comparison (12-hour format to 24-hour if needed)
                                const optionTime = option.value;
                                const optionDisplay = option.textContent;
                                
                                // Check all possible formats for matching
                                const isBooked = data.bookedTimes.some(bookedTime => {
                                    // Clean the booked time string
                                    const cleanedBookedTime = bookedTime.trim();
                                    
                                    // Try different formats for comparison
                                    return (
                                        cleanedBookedTime === optionTime ||
                                        cleanedBookedTime === optionDisplay ||
                                        convertTo12Hour(cleanedBookedTime) === optionDisplay ||
                                        convertTo24Hour(cleanedBookedTime) === optionTime
                                    );
                                });
                                
                                if (isBooked) {
                                    option.disabled = true;
                                    option.textContent += " (Booked)";
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error checking availability:", error);
                        // Hide loading indicator
                        checkingAvailability.style.display = 'none';
                    });
            }
            
            // Helper function to convert 24-hour time to 12-hour time
            function convertTo12Hour(time24) {
                // Handle various input formats
                let hours, minutes;
                
                if (time24.includes(':')) {
                    [hours, minutes] = time24.split(':').map(part => parseInt(part, 10));
                } else if (time24.match(/^\d{1,2}(:\d{2})?\s*(am|pm)$/i)) {
                    // Already in 12-hour format
                    return time24;
                } else {
                    return time24; // Can't parse, return as is
                }
                
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // Convert 0 to 12
                
                return `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }
            
            // Helper function to convert 12-hour time to 24-hour time
            function convertTo24Hour(time12) {
                if (!time12.match(/\d{1,2}:\d{2}\s*(am|pm)/i)) {
                    // If not in 12-hour format, return as is
                    return time12;
                }
                
                const timeMatch = time12.match(/(\d{1,2}):(\d{2})\s*(am|pm)/i);
                if (!timeMatch) return time12;
                
                let [_, hours, minutes, ampm] = timeMatch;
                hours = parseInt(hours, 10);
                
                if (ampm.toLowerCase() === 'pm' && hours < 12) {
                    hours += 12;
                } else if (ampm.toLowerCase() === 'am' && hours === 12) {
                    hours = 0;
                }
                
                return `${hours.toString().padStart(2, '0')}:${minutes}`;
            }
            
            // Update available times based on day
            function updateAvailableTimes(clearFirst = true) {
                if (!dateInput.value) return;
                
                const selectedDate = new Date(dateInput.value);
                const dayOfWeek = selectedDate.getDay();
                
                // Clear options if requested
                if (clearFirst) {
                    timeSelect.innerHTML = '';
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select a time';
                    timeSelect.appendChild(defaultOption);
                }
                
                // Set hours based on day
                let startHour = 10; // Default weekday start for Michael (10 AM)
                let endHour = 19;   // Default end time (7 PM)
                
                if (dayOfWeek === 6) { // Saturday
                    startHour = 9;    // Starts earlier on Saturday
                    endHour = 18;     // Ends earlier on Saturday (6 PM)
                }
                
                // Add time options
                for (let hour = startHour; hour < endHour; hour++) {
                    for (let minute of [0, 30]) {
                        const timeValue = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        
                        // Format for display
                        let displayHour = hour % 12;
                        if (displayHour === 0) displayHour = 12;
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
                        
                        // Check if this option already exists (for when adding to existing options)
                        let optionExists = false;
                        Array.from(timeSelect.options).forEach(existingOption => {
                            if (existingOption.value === timeValue) {
                                optionExists = true;
                            }
                        });
                        
                        // Only add if it doesn't exist already
                        if (!optionExists) {
                            const option = document.createElement('option');
                            option.value = timeValue;
                            option.textContent = displayTime;
                            timeSelect.appendChild(option);
                        }
                    }
                }
            }
            
            // Form submission
            document.getElementById('appointmentForm').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission

                // Validate all fields are filled
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const email = document.getElementById('email').value;
                const service = document.getElementById('service').value;
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                
                if (!name || !phone || !email || !service || !date || !time) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Final validation for availability
                const selectedDate = new Date(date);
                const dayOfWeek = selectedDate.getDay();
                
                // Validate closed days
                if (dayOfWeek === 0 || dayOfWeek === 3) {
                    alert('We are closed on Wednesdays and Sundays. Please select another day.');
                    return;
                }
                
                // Validate Michael's schedule
                if (![1, 4, 5, 6].includes(dayOfWeek)) {
                    alert('Michael is only available on Mondays, Thursdays, Fridays, and Saturdays. Please select another day.');
                    return;
                }
                
                // Check if the selected time option is disabled (already booked)
                const selectedOption = Array.from(timeSelect.options).find(option => option.value === time);
                if (selectedOption && selectedOption.disabled) {
                    alert('This time is already booked. Please select a different time.');
                    return;
                }

                // Format time for display (convert from 24h to 12h format)
                let displayTime = time;
                if (time) {
                    const [hours, minutes] = time.split(':');
                    const hourNum = parseInt(hours, 10);
                    const displayHours = hourNum % 12 || 12;
                    const ampm = hourNum >= 12 ? 'PM' : 'AM';
                    displayTime = `${displayHours}:${minutes} ${ampm}`;
                }

                // Create the data to send
                const appointmentData = {
                    name: name,
                    phone: phone,
                    email: email,
                    barber: "Michael", // Hardcoded since this form is just for Michael
                    service: service,
                    date: date,
                    time: displayTime
                };

                // Calculate appointment duration based on the selected service
                let duration = 60; // Default duration is 60 minutes
                if (service === 'Haircut') {
                    duration = 45;
                } else if (service === 'Beard Trim' || service === 'Hot Towel Shave') {
                    duration = 30;
                } else if (service === 'The Distinguished Gentleman' || service === 'Head & Face Hot Towel Shave') {
                    duration = 75;
                }

                // Format date for display
                const appointmentDate = new Date(date);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = appointmentDate.toLocaleDateString('en-US', options);

                // Create confirmation message
                const confirmationMessage = `Thank you, ${name}! Your appointment has been booked with Michael for ${service} on ${formattedDate} at ${displayTime}. We'll send a confirmation email to ${email} and may contact you at ${phone} if needed.`;
                
                // Use XMLHttpRequest
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://bitethatthing.app.n8n.cloud/webhook/946e8d62-3068-443d-93e6-bedd753af479', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    // Show confirmation
                    document.getElementById('confirmationMessage').textContent = confirmationMessage;
                    document.getElementById('confirmation').style.display = 'block';
                    
                    // Scroll to confirmation
                    document.getElementById('confirmation').scrollIntoView({ behavior: 'smooth' });

                    // Reset the form
                    document.getElementById('appointmentForm').reset();
                    // Remove selected classes
                    document.querySelectorAll('.button-group button.selected').forEach(btn => btn.classList.remove('selected'));
                    // Reset service description
                    serviceDescriptionElement.textContent = "Please select a service to see its description.";
                };
                
                xhr.onerror = function() {
                    // Still show confirmation since the error might just be CORS-related
                    document.getElementById('confirmationMessage').textContent = confirmationMessage;
                    document.getElementById('confirmation').style.display = 'block';
                    
                    // Scroll to confirmation
                    document.getElementById('confirmation').scrollIntoView({ behavior: 'smooth' });
                    
                    // Reset the form
                    document.getElementById('appointmentForm').reset();
                    // Remove selected classes
                    document.querySelectorAll('.button-group button.selected').forEach(btn => btn.classList.remove('selected'));
                    // Reset service description
                    serviceDescriptionElement.textContent = "Please select a service to see its description.";
                };
                
                // Send the data
                xhr.send(JSON.stringify(appointmentData));
            });
        });
    </script>
</body>
</html>
